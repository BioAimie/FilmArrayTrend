query <- paste(queryVector,collapse="\n")
shortnames.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
query
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- readLines('../DataSources/ShortNames.sql')
query <- paste(queryVector,collapse="\n")
shortnames.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
head(runs.df)
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- readLines('../DataSources/SQL/DataCleaningOfQcRuns/AllSitesRespiratoryRuns.sql')
query <- paste(queryVector,collapse="\n")
runs.df <- sqlQuery(FADWcxn,query)
queryVector <- readLines('../DataSources/SQL/DataCleaningOfQcRuns/PositiveBugsRP.sql')
query <- paste(queryVector,collapse="\n")
bugs.df <- sqlQuery(FADWcxn,query)
bugs.df <- bugs.df[bugs.df$BugPositive != 'Bocavirus',]
queryVector <- readLines('../DataSources/ShortNames.sql')
query <- paste(queryVector,collapse="\n")
shortnames.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
head(runs.df)
head(bugs.df)
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- readLines('../DataSources/SQL/DataCleaningOfQcRuns/AllSitesRespiratoryRuns.sql')
query <- paste(queryVector,collapse="\n")
runs.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
PMScxn <- odbcConnect('PMS_PROD')
queryVector <- readLines('../DataSources/SQL/DataCleaningOfQcRuns/ShipDatesOfInstruments.sql')
query <- paste(queryVector, collapse="\n")
shipments.df <- sqlQuery(PMScxn, query)
odbcClose(PMScxn)
library(RODBC)
library(lubridate)
library(EpiWeek)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
require(dateManip)
head(runs.df)
shipments.df[shipments.df$SerialNo %in% runs.df$Instrument, ]
a <- shipments.df[shipments.df$SerialNo %in% runs.df$Instrument, ]
head(a)
shipments.df <- shipments.df[shipments.df$SerialNo %in% runs.df$Instrument, ]
rm(a)
head(shipments.df)
head(runs.df)
shipments.df[shipments.df$SerialNo=='FA3121' & shipments.df$Date < min(runs.df[runs.df$Instrument=='FA3121', 'Date']), ]
unique(runs.df$Instrument)
class(shipments.df$SerialNo)
serials <- unique(runs.df$Instrument)
head(runs.df)
head(shipments.df)
shipments.df[shipments.df$SerialNo=='FA3121', ]
serials
i <- 1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[x], ]
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
runs.df$Instrument <- as.character(runs.df$Instrument)
shipments.df$SerialNo <- as.character(shipments.df$SerialNo)
serials <- unique(runs.df$Instrument)
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.ship.dates
head(runs.df[runs.df$Instrument==serials[i], ])
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
head(inst.ship.dates)
head(inst.run.dates)
j <- 1
min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date']) - inst.ship.dates$Date[j]
as.numeric(min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date']) - inst.ship.dates$Date[j])
as.numeric(min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date']) - inst.ship.dates$Date[2])
as.numeric(min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date']) - inst.ship.dates$Date[3])
as.numeric(min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date']) - inst.ship.dates$Date[4])
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs
with(inst.first.runs[!(is.na(inst.first.runs$FirstRunDate)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
inst.first.runs[!(is.na(inst.first.runs$FirstRunDate)), ]
inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ]
with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
head(inst.first.runs)
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))
serials[2]
i <- 2
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate')]
inst.first.runs
inst.first.runs[with(inst.first.runs, order(ShipDate)), ]
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- 3
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
inst.first.runs
inst.first.runs[with(inst.first.runs, order(ShipDate)), ]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
i <- i+1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
head(runs.df)
ggplot(subset(runs.df, Instrument %in% serials[1:10]), aes(x=Date)) + geom_bar() + facet_wrap(~Instrument)
ggplot(subset(runs.df, Instrument %in% serials[10:20]), aes(x=Date)) + geom_bar() + facet_wrap(~Instrument)
serials[13]
serials
serials <- unique(runs.df$Instrument)[order(unique(runs.df$Instrument))]
serials
serials[155]
i <- 155
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
serials <- unique(runs.df$Instrument)[order(unique(runs.df$Instrument))]
inst.arrival.dates <- c()
for(i in 1:length(serials)) {
print(serials[i])
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
temp <- merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
inst.arrival.dates <- rbind(inst.arrival.dates, temp)
}
which(serials=='FA2116')
inst.first.runs
runs.df[runs.df$Instrument=='FA2116', ]
min(runs.df[runs.df$Instrument=='FA2116', 'Date'])
inst.first.runs
max(runs.df[runs.df$Instrument=='FA2116','Date'])
PMScxn <- odbcConnect('PMS_PROD')
queryVector <- readLines('../DataSources/SQL/DataCleaningOfQcRuns/ShipDatesOfInstruments.sql')
query <- paste(queryVector, collapse="\n")
shipments.df <- sqlQuery(PMScxn, query)
shipments.df <- shipments.df[shipments.df$SerialNo %in% runs.df$Instrument, ]
shipments.df$SerialNo <- as.character(shipments.df$SerialNo)
odbcClose(PMScxn)
serials <- unique(runs.df$Instrument)[order(unique(runs.df$Instrument))]
inst.arrival.dates <- c()
for(i in 1:length(serials)) {
print(serials[i])
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
temp <- merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
inst.arrival.dates <- rbind(inst.arrival.dates, temp)
}
inst.arrival.dates
hist(inst.arrival.dates$DaysSinceShipment)
View(inst.arrival.dates)
inst.arrival.dates[with(inst.arrival.dates, order(Instrument, ShipDate)), ]
inst.arrival.dates <- inst.arrival.dates[with(inst.arrival.dates, order(Instrument, ShipDate)), ]
View(inst.arrival.dates)
runs.df[runs.df$Instrument=='2FA00152', ]
hist(inst.arrival.dates$DaysSinceShipment)
median(inst.arrival.dates$DaysSinceShipment)
runs.df[runs.df$Instrument=='2FA00576', ]
head(bugs.df)
with(data.frame(bugs.df, Positives = 1), aggregate(Positives~RunDataId, FUN=sum))
positives.per.run <- with(data.frame(bugs.df, Positives = 1), aggregate(Positives~RunDataId, FUN=sum))
head(runs.df)
runs.df <- merge(runs.df, positives.per.run, by='RunDataId', all.x=TRUE)
runs.df[is.na(runs.df$Positives),'Positives'] <- 0
head(runs.df)
library(ggplot2)
ggplot(subset(runs.df, Instrument=='FA3121'), aes(x=Date, fill=Positives)) + geom_bar()
ggplot(subset(runs.df, Instrument=='FA3121'), aes(x=Date, fill=as.factor(Positives))) + geom_bar()
head(inst.arrival.dates)
inst.arrival.dates[inst.arrival.dates$DaysSinceShipment < 30, ]
inst.arrival.dates.trim <- inst.arrival.dates[inst.arrival.dates$DaysSinceShipment < 30, ]
head(inst.arrival.dates.trim)
head(runs.df)
a <- merge(runs.df, inst.arrival.dates.trim, by.x=c('Instrument','Date'), by.y=c('Instrument','FirstRunDate'), all.x=TRUE)
head(a)
head(a)
a[a$Instrument=='FA00081' & is.na(a$ShipDate), ]
a[a$Instrument=='FA00081' & is.na(a$DaysSinceShipment), ]
a[a$Instrument=='2FA00081' & is.na(a$DaysSinceShipment), ]
head(a[a$Instrument=='2FA00081' & is.na(a$DaysSinceShipment), ])
ggplot(a[a$Instrument=='2FA00081' & is.na(a$DaysSinceShipment), ], aes(x=Date, fill=as.factor(Positives))) + geom_bar()
a[a$Instrument=='2FA00081' & is.na(a$DaysSinceShipment), ]
a[a$Instrument=='2FA00081' & is.na(a$DaysSinceShipment), ]
a[a$Instrument=='2FA00081' & is.na(a$DaysSinceShipment), ]
head(inst.arrival.dates.trim)
head(runs.df)
head(a)
runs.arrivals.marked <- merge(runs.df, inst.arrival.dates.trim, by.x=c('Instrument','Date'), by.y=c('Instrument','FirstRunDate'), all.x=TRUE)
head(a)
head(runs.arrivals.marked)
rm(a)
serials.trim <- as.character(unique(runs.arrivals.marked$Instrument))
a <- runs.arrivals.marked[runs.arrivals.marked$Instrument=='FA1206', ]
head(a)
View(a)
a[!(is.na(a$DaysSinceShipment)), ]
inst.first.runs
head(runs.df)
unique(runs.df$Name)
head(a)
rm(a)
# read in the data about dates of instrument shipments from PMS_PROD
PMScxn <- odbcConnect('PMS_PROD')
queryVector <- readLines('../DataSources/SQL/DataCleaningOfQcRuns/ShipDatesOfInstruments.sql')
query <- paste(queryVector, collapse="\n")
shipments.df <- sqlQuery(PMScxn, query)
shipments.df <- shipments.df[shipments.df$SerialNo %in% runs.df$Instrument, ]
shipments.df$SerialNo <- as.character(shipments.df$SerialNo)
odbcClose(PMScxn)
workDir <-'~/FilmArrayTrend/DataCleaningOfQcRuns/'
setwd(workDir)
# load libraries
library(RODBC)
library(lubridate)
library(EpiWeek)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
require(dateManip)
# load custom functions
source('~/WebHub/AnalyticsWebHub/Rfunctions/createPaletteOfVariableLength.R')
PMScxn <- odbcConnect('PMS_PROD')
queryVector <- readLines('../DataSources/SQL/DataCleaningOfQcRuns/ShipDatesOfInstruments.sql')
query <- paste(queryVector, collapse="\n")
shipments.df <- sqlQuery(PMScxn, query)
shipments.df <- shipments.df[shipments.df$SerialNo %in% runs.df$Instrument, ]
shipments.df$SerialNo <- as.character(shipments.df$SerialNo)
odbcClose(PMScxn)
serials <- unique(runs.df$Instrument)[order(unique(runs.df$Instrument))]
inst.arrival.dates <- c()
for(i in 1:length(serials)) {
print(serials[i])
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
temp <- merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
inst.arrival.dates <- rbind(inst.arrival.dates, temp)
}
inst.arrival.dates <- inst.arrival.dates[with(inst.arrival.dates, order(Instrument, ShipDate)), ]
inst.ship.dates[inst.ship.dates$SerialNo=='2FA02864', ]
runs.df[runs.df$Instrument=='2FA02864', ]
nrow(inst.ship.dates)
for(i in 1:length(serials)) {
print(serials[i])
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
if(nrow(inst.ship.dates)==0) { next() }
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
temp <- merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
inst.arrival.dates <- rbind(inst.arrival.dates, temp)
}
runs.df[runs.df$Instrument=='FA2191', ]
shipments.df[shipments.df$SerialNo=='FA2191', ]
head(inst.ship.dates)
head(inst.run.dates)
head(inst.first.run)
inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date']
head(runs.df)
head(shipments.df)
a <- runs.df[runs.df$Instrument=='FA3121', ]
shipments.df[shipments.df$SerialNo=='FA3121', ]
b <- shipments.df[shipments.df$SerialNo=='FA3121', ]
head(a)
serials
a <- runs.df[runs.df$Instrument=='FA1278', ]
b <- shipments.df[shipments.df$SerialNo=='FA1278', ]
b
head(a)
head(a[a$Date > min(b$Date), ])
head(a[a$Date > b$Date[2], ])
head(a[a$Date > b$Date[2] & a$Date < b$Date[1], ])
b$Date[1]
b$Date[2]
b$Date[3]
head(a[a$Date > b$Date[2] & a$Date < b$Date[1], ])
head(a[a$Date > b$Date[1] & a$Date < b$Date[3], ])
heaD(b)
head(b)
b <- b[with(b, order(Date)), ]
serials <- unique(runs.df$Instrument)[order(unique(runs.df$Instrument))]
inst.arrival.dates <- c()
for(i in 1:length(serials)) {
print(serials[i])
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
temp <- merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
inst.arrival.dates <- rbind(inst.arrival.dates, temp)
}
inst.arrival.dates <- inst.arrival.dates[with(inst.arrival.dates, order(Instrument, ShipDate)), ]
head(inst.arrival.dates)
head(inst.first.runs.agg)
head(inst.arrival.dates)
head(runs.arrivals.marked)
head(runs.df)
head(runs.df)
head(inst.arrival.dates)
head(runs.arrivals.marked)
as.character(unique(runs.arrivals.marked$Instrument))
a <- runs.arrivals.marked[runs.arrivals.marked$Instrument=='FA1278', ]
head(a)
head(a)
head(temp)
which(serials=='FA1278')
i <- 155
j <- 1
inst.ship.dates <- shipments.df[shipments.df$SerialNo==serials[i], ]
inst.run.dates <- runs.df[runs.df$Instrument==serials[i], ]
inst.first.runs <- c()
for(j in 1:length(inst.ship.dates$Date)) {
inst.first.run <- min(inst.run.dates[inst.run.dates$Date >= inst.ship.dates$Date[j], 'Date'])
days.since.shipped <- as.numeric(inst.first.run - inst.ship.dates$Date[j])
temp <- data.frame(Instrument = serials[i], ShipDate = inst.ship.dates$Date[j], FirstRunDate = inst.first.run, DaysSinceShipment = days.since.shipped)
inst.first.runs <- rbind(inst.first.runs, temp)
}
inst.first.runs.agg <- with(inst.first.runs[!(is.infinite(inst.first.runs$DaysSinceShipment)), ], aggregate(DaysSinceShipment~FirstRunDate, FUN=min))
temp <- merge(inst.first.runs, inst.first.runs.agg, by=c('FirstRunDate','DaysSinceShipment'))[,c('Instrument','ShipDate','FirstRunDate', 'DaysSinceShipment')]
temp
inst.run.dates
temp
head(inst.run.dates)
inst.run.dates[inst.run.dates$Date < temp$ShipDate[1], ]
inst.run.dates[inst.run.dates$Date > temp$ShipDate[1], ]
inst.run.dates[inst.run.dates$Date < temp$ShipDate[1], ]
head(a)
head(inst.run.dates)
temp
