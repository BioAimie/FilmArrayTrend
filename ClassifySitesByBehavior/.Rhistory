setwd('~/FilmArrayTrend/ClassifySitesByBehavior/')
library(RODBC)
library(lubridate)
library(EpiWeek)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
library(RColorBrewer)
library(devtools)
library(RCurl)
library(binom)
library(caret)
library(randomForest)
require(dateManip)
source('Rfunctions/normalizeBurnRate.R')
source('~/WebHub/AnalyticsWebHub/Rfunctions/createPaletteOfVariableLength.R')
source('../Rfunctions/normalizeBurnRate.R')
scan('../DataSources/SQL/ClassifySitesByBehavior/RunDataBySite.sql',what=character(),quote="")
# load the data
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- scan('../DataSources/SQL/ClassifySitesByBehavior/RunDataBySite.sql',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
runs.df <- sqlQuery(FADWcxn,query)
queryVector <- scan('../DataSources/SQL/ClassifySitesByBehavior/TargetDataByRun.sql',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
bugs.df <- sqlQuery(FADWcxn,query)
bugs.df <- bugs.df[bugs.df$BugPositive != 'Bocavirus',]
queryVector <- scan('../DataSources/ShortNames.sql',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
shortnames.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
# read in data from PMS PROD server
PMScxn <- odbcConnect('PMS_PROD')
queryVector <- scan('DataSources/AllSitesRegionKey.txt',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
regions.df <- sqlQuery(PMScxn,query)
odbcClose(PMScxn)
PMScxn <- odbcConnect('PMS_PROD')
queryVector <- scan('../DataSources/AllSitesRegionKey.txt',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
regions.df <- sqlQuery(PMScxn,query)
odbcClose(PMScxn)
calendar.df <- transformToEpiWeeks(createCalendarLikeMicrosoft(2012, 'Week'))
calendar.df$YearWeek <- with(calendar.df, ifelse(Week < 10, paste(Year, Week, sep='-0'), paste(Year, Week, sep='-')))
calendar.df <- calendar.df[calendar.df$YearWeek > '2012-51', ]
calendar.df$Days <- 1
head(runs.df)
head(regions.df)
runs.reg <- merge(runs.df, data.frame(Province = regions.df$StateAbv, Region = regions.df$CensusRegionLocal), by='Province')
runs.reg$Record <- 1
runs.reg.date <- merge(runs.reg[,c('RunDataId','Instrument','Date','Name','CustomerSiteId','Region','Record')], calendar.df[,c('Date','Year','Week','YearWeek')], by='Date')
head(runs.reg.date)
head(bugs.df)
queryVector <- scan('../DataSources/SQL/ClassifySitesByBehavior/TargetDataByRun.sql',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
bugs.df <- sqlQuery(FADWcxn,query)
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- scan('../DataSources/SQL/ClassifySitesByBehavior/TargetDataByRun.sql',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
bugs.df <- sqlQuery(FADWcxn,query)
bugs.df <- bugs.df[bugs.df$Target != 'Bocavirus',]
head(bugs.df)
head(bugs.df)
head(runs.reg.date)
bugs.reg.date <- merge(runs.reg.date[,c('RunDataId','Date','Year','Week','CustomerSiteId')], subset(bugs.df, ResultType != 'Control'), by='RunDataId')
controls.reg.date <- merge(runs.reg.date[,c('RunDataId','Date','Year','Week','CustomerSiteId')], subset(bugs.df, ResultType == 'Control'), by='RunDataId')
head(bugs.reg.date)
head(controls.reg.date)
head(bugs.reg.date)
with(data.frame(bugs.reg.date, Positives = 1), aggregate(Positives~Year+Week+CustomerSiteId+Target+ResultType, FUN=sum))
bugs.reg.agg <- with(data.frame(bugs.reg.date, Positives = 1), aggregate(Positives~Year+Week+CustomerSiteId+Target+ResultType, FUN=sum))
heaD(runs.reg.date)
head(runs.reg.date)
runs.reg.agg <- with(data.frame(runs.reg.date, Runs = 1), aggregate(Runs~Year+Week+CustomerSiteId+Region, FUN=sum))
regions.df
head(regions.df)
head(regions.df)
unique(as.character(regions.df$CensusRegionLocal))
unique(as.character(regions.df$CensusRegionNational))
unqiue(runs.reg.date$Region)
unique(runs.reg.date$Region)
as.character(unique(runs.reg.date$Region))
unique(regions.df[,c('CensusRegionLocal','')])
unique(regions.df[,c('CensusRegionLocal','CensusRegion')])
runs.reg.agg <- with(data.frame(runs.reg.date, Runs = 1), aggregate(Runs~Year+Week+CustomerSiteId, FUN=sum))
runs.reg.agg <- with(data.frame(runs.reg.date, Runs = 1), aggregate(Runs~Year+Week+CustomerSiteId+Region, FUN=sum))
runs.reg <- merge(runs.df, data.frame(Province = regions.df$StateAbv, Region = regions.df$CensusRegion), by='Province')
runs.reg$Runs <- 1
runs.reg.date <- merge(runs.reg[,c('RunDataId','Instrument','Date','Name','CustomerSiteId','Region','Runs')], calendar.df[,c('Date','Year','Week','YearWeek')], by='Date')
head(runs.reg.date)
bugs.reg.date <- merge(runs.reg.date[,c('RunDataId','Date','Year','Week','CustomerSiteId')], subset(bugs.df, ResultType != 'Control'), by='RunDataId')
runs.reg.agg <- with(runs.reg.date, aggregate(Runs~Year+Week+CustomerSiteId+Region, FUN=sum))
head(runs.reg.agg)
head(bugs.reg.agg)
unique(bugs.reg.agg[bugs.reg.agg$ResultType=='Organism', ])
head(bugs.reg.agg)
unique(bugs.reg.agg[bugs.reg.agg$ResultType=='Organism', c('Year','Week','CustomerSiteId','Target')])
data.frame(unique(bugs.reg.agg[bugs.reg.agg$ResultType=='Organism', c('Year','Week','CustomerSiteId','Target')]), Organisms = 1)
rm(runs.reg.agg, bugs.reg.agg)
runs.reg.count <- with(runs.reg.date, aggregate(Runs~Year+Week+CustomerSiteId+Region, FUN=sum))
bugs.reg.count <- with(data.frame(bugs.reg.date, Positives = 1), aggregate(Positives~Year+Week+CustomerSiteId+Target+ResultType, FUN=sum))
bugs.reg.unique <- data.frame(unique(bugs.reg.count[bugs.reg.count$ResultType=='Organism', c('Year','Week','CustomerSiteId','Target')]), Organisms = 1)
