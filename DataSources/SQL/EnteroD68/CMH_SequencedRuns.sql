SET NOCOUNT ON

SELECT 
	R.[Id],
	R.[PouchSerialNumber],
	26 AS [CustomerSiteId],
	CAST(R.[StartTime] AS DATE) AS [Date],
	R.[PouchLotNumber] AS [LotNo],
	R.[InstrumentSerialNumber] AS [SerialNo]
INTO #runs
FROM [FILMARRAYDB].[FilmArray1].[FilmArray].[ExperimentRun] R WITH(NOLOCK)
WHERE [PouchSerialNumber] IN 
(
	'01500970', '01500971', '01500975', '01500976', '01500979', '01500992', '01501012', '01501036','01501041','01501931','01501935','01501971',	'01501972','01501973',
	'01501974','01501976','01501977','01501979','01501981','01501985','01502003','01502407','01502414','01502416','01502417','01502418','01502419','01502420','01502435',
	'01502436','01502437','01502443','01502444''01502450','01502452','01502454','01502478','01502484','01502875','01502887','01502892','01502898','01502905','01502911',
	'01502923','01502926','01502931','01502950','01503083','01594312','01594328','01594333','01594334','01594339','01594340','01594343','01594347','01594351','01594385',
	'01595655','01595656','01595664','01595674','01595675','01595702','01595710','01595712','01595713','01595714','01595721','01595730','01595732','01595733','01595737',
	'01595740','01595752','01595757','01595758','01595770','01595771','01595772','01595791','01595792','01595793','01595822','01595824','01595825','01595830','01595831',
	'01595832','01595834','01595841','01595842','01595843','01595844','01596041','01596044','01596055','01596056','01596062','01596064','01596065','01596067','01596068',
	'01596076','01596077','01596078','01596080','01596086','01596090','01596095','01596236','01596263','01596276','01596292','01596306','01596331','01596333','01596338',
	'01596340','01596341','01596342','01596347','01596358','01596360','01596367','01596377','01596378','01596388','01596401','01596411','01596429','01596431','01596444',
	'01596476','01596478','01596491','01596509','01596519','01596521','01596528','01596529','01596531','01596535','01596537','01596541','01596543','01596547','01596565',
	'01596568','01596581','01596584','01596589','01596590','01596610','01596710','01596711','01596712','01596713','01596714','01596716','01596717','01596718','01596720',
	'01596721','01596727','01596730','01596732','01596741','01596743','01596744','01596748','01596749','01596750','01596752','01596753','01596754','01596756','01596757',
	'01596759','01596769','01596778','01596781','01596782','01596786','01596789','01596790','01596793','01596799','01596807','01596809','01596816','01596817','01596825',
	'01596837','01596838','01596839','01596844','01596858','01596859','01596863','01596872','01596875','01596876','01596889','01596891','01596892','01596894','01596896',
	'01633974','01633984','01633988','01633992','01634009','01634015','01634021','01634026','01634033','01634039','01634041','01634046','01634057','01634168','01634171',
	'01634172',
	'01634176',
	'01634177',
	'01634189',
	'01634194',
	'01634198',
	'01634199',
	'01634200',
	'01634202',
	'01634222',
	'01634236',
	'01634245',
	'01634251',
	'01634252',
	'01634257',
	'01634266',
	'01634373',
	'01634375',
	'01634376',
	'01634377',
	'01634384',
	'01634390',
	'01634401',
	'01634411',
	'01634444',
	'01634451',
	'01634452',
	'01634457',
	'01634469',
	'01634470',
	'01634474',
	'01634475',
	'01634476',
	'01634478',
	'01634480',
	'01634481',
	'01634482',
	'01634483',
	'01634486',
	'01634487',
	'01634488',
	'01634490',
	'01634498',
	'01634500',
	'01634502',
	'01634503',
	'01634504',
	'01634506',
	'01634507',
	'01634516',
	'01634520',
	'01634522',
	'01634523',
	'01634527',
	'01634533',
	'01634539',
	'01634544',
	'01634545',
	'01634546',
	'01634551',
	'01634552',
	'01634555',
	'01634559',
	'01634566',
	'01634572',
	'01634576',
	'01634581',
	'01634605',
	'01634615',
	'01634617',
	'01634633',
	'01634639',
	'01634648',
	'01634654',
	'01634661',
	'01635268',
	'01635269',
	'01635279',
	'01635283',
	'01635285',
	'01635287',
	'01635298',
	'01635307',
	'01635315',
	'01635316',
	'01635320',
	'01635336',
	'01635347',
	'01635350',
	'01635360',
	'01635483',
	'01635501',
	'01635515',
	'01635521',
	'01635522',
	'01635528',
	'01635536',
	'01635543',
	'01635544',
	'01635551',
	'01635554',
	'01635555',
	'01635562',
	'01635879',
	'01635880',
	'01635881',
	'01635885',
	'01635888',
	'01635889',
	'01635892',
	'01635897',
	'01635901',
	'01635903',
	'01635905',
	'01635915',
	'01635929',
	'01635933',
	'01635934',
	'01635935',
	'01635936',
	'01635951',
	'01636369',
	'01636378',
	'01636379',
	'01636382',
	'01636388',
	'01636398',
	'01636400',
	'01636406',
	'01636421',
	'01636430',
	'01636437',
	'01636443',
	'01636445',
	'01636446',
	'01636449',
	'01636451',
	'01636452',
	'01636469',
	'01636474',
	'01636488',
	'01636505',
	'01636517',
	'01636527',
	'01636533',
	'01636534',
	'01636537',
	'01636542',
	'01636543',
	'01636555',
	'01636559',
	'01636561',
	'01636569',
	'01636579',
	'01636581',
	'01636589',
	'01636599',
	'01636600',
	'01636601',
	'01636603',
	'01636607',
	'01636619',
	'01636621',
	'01636625',
	'01636627',
	'01636649',
	'01647506',
	'01647509',
	'01647514',
	'01647528',
	'01647531',
	'01647568',
	'01647573',
	'01647589',
	'01647590',
	'01647591',
	'01647610',
	'01647614',
	'01647618',
	'01647620',
	'01647627',
	'01647632',
	'01647635',
	'01647647',
	'01647650',
	'01647651',
	'01647655',
	'01647658',
	'01647660',
	'01647679',
	'01647680',
	'01647694',
	'01647725',
	'01647748',
	'01647752',
	'01647753',
	'01647770',
	'01647775',
	'01647780',
	'01647785',
	'01647788',
	'01647792',
	'01647793',
	'01647797',
	'01647803',
	'01647805',
	'01647807',
	'01647821',
	'01647825',
	'01647826',
	'01647830',
	'01647832',
	'01647833',
	'01647834',
	'01647836',
	'01647837',
	'01647838',
	'01647840',
	'01647858',
	'01647873',
	'01647889',
	'01647891',
	'01647894',
	'01647895',
	'01647902',
	'01647904',
	'01647907',
	'01647908',
	'01647909',
	'01647911',
	'01647914',
	'01647915',
	'01647920',
	'01647923',
	'01647948',
	'01647959',
	'01647984',
	'01647986',
	'01647989',
	'01648111',
	'01648112',
	'01648114',
	'01648118',
	'01648127',
	'01648130',
	'01648141',
	'01648174',
	'01648189',
	'01648193',
	'01648194',
	'01648302',
	'01648305',
	'01648309',
	'01648311',
	'01648314',
	'01648318',
	'01648319',
	'01648321',
	'01648323',
	'01648328',
	'01648330',
	'01648331',
	'01648333',
	'01648336',
	'01648337',
	'01648341',
	'01648342',
	'01648357',
	'01648360',
	'01648369',
	'01648372',
	'01648374',
	'01648375',
	'01648384',
	'01648386',
	'01648388',
	'01648392',
	'01648393',
	'01648394',
	'01648395',
	'01648403',
	'01648407',
	'01648411',
	'01648415',
	'01648418',
	'01648419',
	'01648420',
	'01648421',
	'01648424',
	'01648434',
	'01648445',
	'01648450',
	'01648452',
	'01648454',
	'01648455',
	'01648466',
	'01648468',
	'01648476',
	'01648480',
	'01648484',
	'01648485',
	'01648486',
	'01648488',
	'01648490',
	'01648491',
	'01648492',
	'01648496',
	'01648497',
	'01648498',
	'01650133',
	'01650160',
	'01650184',
	'01660764',
	'01660769',
	'01660783',
	'01660784',
	'01660791',
	'01660792',
	'01660795',
	'01660799',
	'01660802',
	'01660836',
	'01660844',
	'01660854',
	'01661069',
	'01661073',
	'01661076',
	'01661077',
	'01661083',
	'01661085',
	'01661086',
	'01661088',
	'01661094',
	'01661096',
	'01661100',
	'01661105',
	'01661109',
	'01661113',
	'01661118',
	'01661129',
	'01661131',
	'01661133',
	'01661136',
	'01661139',
	'01661144',
	'01661146',
	'01661149',
	'01661150',
	'01661151',
	'01661153',
	'01661168',
	'01661174',
	'01661180',
	'01661196',
	'01661199',
	'01661211',
	'01661217',
	'01661219',
	'01661240',
	'01661241',
	'01661242',
	'01661251',
	'01661254',
	'01661568',
	'01661571',
	'01661577',
	'01661578',
	'01661580',
	'01661586',
	'01661610',
	'01661613',
	'01661615',
	'01661624',
	'01661641',
	'01661643',
	'01661659',
	'01661662',
	'01661669',
	'01661675',
	'01661689',
	'01661691',
	'01661698',
	'01661725',
	'01661733',
	'01661742',
	'01661781',
	'01661783',
	'01661807',
	'01661812',
	'01661816',
	'01661819',
	'01661823',
	'01661835',
	'01661836',
	'01661839',
	'01661844',
	'01661858',
	'01661865',
	'01661866',
	'01661871',
	'01661881',
	'01661883',
	'01661892',
	'01661894',
	'01661898',
	'01661930',
	'01661933',
	'01661944',
	'01661947',
	'01661949',
	'01661953',
	'01661964',
	'01661993',
	'01662017',
	'01662021',
	'01662027',
	'01662033',
	'01662034',
	'01662035',
	'01662182',
	'01662186',
	'01662189',
	'01662197',
	'01662198',
	'01662201',
	'01662202',
	'01662203',
	'01662205',
	'01662221',
	'01662235',
	'01662236',
	'01662239',
	'01662247',
	'01662772',
	'01662780',
	'01662782',
	'01662798',
	'01662799',
	'01662800',
	'01662825',
	'01662828',
	'01662854',
	'01662855',
	'01741455',
	'01741465',
	'01741469',
	'01741470',
	'01741484',
	'01741488',
	'01741489',
	'01741490',
	'01741491',
	'01741498',
	'01741507',
	'01741510',
	'01741517',
	'01741518',
	'01741549',
	'01743764',
	'01743779',
	'01743780',
	'01743791',
	'01743792',
	'01743795',
	'01743796',
	'01743797',
	'01743798',
	'01743800',
	'01743833',
	'01743841',
	'01744141',
	'01744641',
	'01744670',
	'01744685',
	'01744690',
	'01744708',
	'01745794',
	'01745804'
)

SELECT 
	ER.[Id],
	'Human Rhinovirus/Enterovirus' AS [TargetName],
	AA.[Name] AS [AssayName],
	IIF([Cp] IS NULL OR [Cp] = 0, 30, [Cp]) AS [Cp],
	[Tm1] AS [Tm],
	[MaxFluor]
INTO #assayData
FROM [FILMARRAYDB].[FilmArray2].[dbo].[AssayResult] AR WITH(NOLOCK) INNER JOIN [FILMARRAYDB].[FilmArray2].[dbo].[Assay] AA WITH(NOLOCK) 
	ON AR.[assay_id] = AA.[Id] INNER JOIN [FILMARRAYDB].[FilmArray2].[dbo].[Assay_Reaction] ARX WITH(NOLOCK) 
		ON AA.[Id] = ARX.[assay_id] INNER JOIN  [FILMARRAYDB].[FilmArray2].[dbo].[Reaction] RX WITH(NOLOCK) 
			ON ARX.[reaction_id] = RX.[Id] INNER JOIN [FILMARRAYDB].[FilmArray2].[dbo].[ReactionResult] RR WITH(NOLOCK) 
				ON RX.[Id] = RR.[reaction_id] INNER JOIN [FILMARRAYDB].[FilmArray2].[dbo].[MetaAnalysis] MA WITH(NOLOCK) 
					ON AR.[analysis_id] = MA.[Id] INNER JOIN [FILMARRAYDB].[FilmArray2].[dbo].[ExperimentRun] ER WITH(NOLOCK) 
						ON MA.[experiment_id] = ER.[Id]
WHERE ER.[Id] IN (SELECT [Id] FROM #runs) AND [MeltDetectorCall] = 'Positive'

SELECT
	R.[PouchSerialNumber],
	R.[CustomerSiteId],
	R.[Date],
	R.[LotNo],
	R.[SerialNo],
	1 AS [PositiveAssays],
	0 AS [PositiveGenes],
	T.[TargetName],
	T.[AssayName],
	T.[Cp],
	T.[Tm],
	T.[MaxFluor],
	T.[AssayType]
INTO #master
FROM #runs R INNER JOIN 
(
	SELECT 
		A.*
	FROM 
	(
		SELECT *,
			IIF(A.[AssayName] IN ('yeastRNA', 'PCR2'), 'Control', 'Organism') AS [AssayType]
		FROM #assayData A
		WHERE (A.[AssayName] LIKE 'Entero%' OR A.[AssayName] LIKE 'HRV%' OR A.[AssayName] = 'yeastRNA' OR A.[AssayName] = 'PCR2') 
	) A INNER JOIN
	(
		SELECT 
			[Id],
			[AssayName],
			COUNT([Cp]) AS [WellsPositive]
		FROM #assayData A
		WHERE (A.[AssayName] LIKE 'Entero%' OR A.[AssayName] LIKE 'HRV%' OR A.[AssayName] = 'yeastRNA')
		GROUP BY [Id], [AssayName]
	) P
		ON A.[Id] = P.[Id] AND A.[AssayName] = P.[AssayName]
	WHERE P.[WellsPositive] > 1
) T
	ON R.[Id] = T.[Id]

SELECT
	[RunDataId] + 12348888888 AS [RunDataId],
	M.*
FROM #master M INNER JOIN
(
	SELECT ROW_NUMBER() OVER(ORDER BY [PouchSerialNumber]) AS [RunDataId],
		[PouchSerialNumber]
	FROM
	(
		SELECT DISTINCT 
			[PouchSerialNumber]
		FROM #master
	) T
) T
	ON M.[PouchSerialNumber] = T.[PouchSerialNumber]

DROP TABLE #runs, #assayData, #master