library(RODBC)
library(lubridate)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
library(RColorBrewer)
library(devtools)
library(dplyr)
library(tidyr)
require(dateManip)
source('~/WebHub/AnalyticsWebHub/Rfunctions/createPaletteOfVariableLength.R')
# dual axes for ILI overlay plots
hinvert_title_grob <- function(grob){
# Swap the widths
widths <- grob$widths
grob$widths[1] <- widths[3]
grob$widths[3] <- widths[1]
grob$vp[[1]]$layout$widths[1] <- widths[3]
grob$vp[[1]]$layout$widths[3] <- widths[1]
# Fix the justification
grob$children[[1]]$hjust <- 1 - grob$children[[1]]$hjust
grob$children[[1]]$vjust <- 1 - grob$children[[1]]$vjust
grob$children[[1]]$x <- unit(1, "npc") - grob$children[[1]]$x
grob
}
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- readLines('../DataSources/SQL/TURN/RunDataBySite.sql')
query <- paste(queryVector,collapse="\n")
runs.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
# read in data from PMS PROD server
PMScxn <- odbcConnect('PMS_PROD')
queryVector <- scan('../DataSources/AllSitesRegionKey.txt',what=character(),quote="")
query <- paste(queryVector,collapse=" ")
regions.df <- sqlQuery(PMScxn,query)
odbcClose(PMScxn)
calendar.df <- transformToEpiWeeks(createCalendarLikeMicrosoft(2012, 'Week'))
calendar.df$YearWeek <- with(calendar.df, ifelse(Week < 10, paste(Year, Week, sep='-0'), paste(Year, Week, sep='-')))
calendar.df <- calendar.df[calendar.df$YearWeek > '2012-51', ]
calendar.df$Days <- 1
head(runs.df)
head(regions.df)
runs.reg <- merge(runs.df, data.frame(Province = regions.df$StateAbv, Region = regions.df$CensusRegionLocal), by='Province')
runs.reg.date <- merge(runs.reg[,c('RunDataId','Instrument','Date','Name','CustomerSiteId','Region','Record')], calendar.df[,c('Date','Year','Week','YearWeek')], by='Date')
runs.reg <- merge(runs.df, data.frame(Province = regions.df$StateAbv, Region = regions.df$CensusRegionLocal), by='Province')
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- readLines('../DataSources/CustomerSiteIdsWithNames.sql')
query <- paste(queryVector,collapse="\n")
names.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
head(runs.df)
head(names.df)
runs.reg <- merge(merge(runs.df, names.df[,c('CustomerSiteId','State')], by='CustomerSiteId'), data.frame(Province = regions.df$StateAbv, Region = regions.df$CensusRegionLocal), by.x='State', by.y='Province')
head(runs.reg)
head(runs.reg)
runs.reg.date <- merge(runs.reg[,c('RunDataId','Instrument','Date','Name','CustomerSiteId','Region','Record')], calendar.df[,c('Date','Year','Week','YearWeek')], by='Date')
runs.reg.date <- merge(runs.reg, calendar.df[,c('Date','Year','Week','YearWeek')], by='Date')
head(runs.df)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
head(runs.df)
turn(runs.reg, 'CustomerSiteId', '26', calendar.df)
head(calendar.df)
head(runs.reg)
runs.reg.date <- merge(runs.reg, calendar.df[,c('Date','Year','Week','YearWeek')], by='Date')
head(runs.reg)
head(runs.reg.date)
turn(runs.reg.date, 'CustomerSiteId', '26', calendar.df)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
turn(runs.reg.date, 'CustomerSiteId', '26', calendar.df)
a <- turn(runs.reg.date, 'CustomerSiteId', '26', calendar.df)
head(a)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '26', calendar.df)
head(a)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '26', calendar.df)
head(a)
View(a)
View(a)
a <- turn(runs.reg.date, 'CustomerSiteId', '25', calendar.df)
a[is.na(a)]
a[is.na(a), ]
a[is.na(a)]
a[is.na(a$Runs), ]
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '25', calendar.df)
View(a)
a <- turn(runs.reg.date, 'CustomerSiteId', '9', calendar.df)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '9', calendar.df)
View(a)
a[is.na(a)] < 0
a[is.na(a)] <- 0
View(a)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '9', calendar.df)
a[is.na(a)] <- 0
View(a)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '9', calendar.df)
a[is.na(a)] <- 0
View(a)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '9', calendar.df)
a <- turn(runs.reg.date, 'CustomerSiteId', '26', calendar.df)
a <- turn(runs.reg.date, 'CustomerSiteId', '7', calendar.df)
head(a)
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity')
ggplot(a, aes(x=YearWeek, y=Panels)) + geom_bar(stat='identity')
runs.reg.date[runs.reg.date$CustomerSiteId==7, ]
b <- runs.reg.date[runs.reg.date$CustomerSiteId==7, ]
head(b)
b[b$Panel=='ME', ]
head(a)
rm(b)
lm(Runs~Instruments, data=a)
summary(lm(Runs~Instruments, data=a))
summary(lm(Runs~Panels, data=a))
summary(lm(Runs~Instruments+Panels, data=a))
head(a)
head(runs.reg.date)
ggplot(runs.reg.date, aes(x=YearWeek, y=Run, fill=Panel)) + geom_bar(stat='identity') + facet_wrap(~CustomerSiteId)
ggplot(runs.reg.date, aes(x=YearWeek, y=Run, fill=Panel)) + geom_bar(stat='identity') + facet_wrap(~CustomerSiteId, scale='free_y')
library(RODBC)
library(lubridate)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
library(RColorBrewer)
library(devtools)
library(dplyr)
library(tidyr)
require(dateManip)
# load custom functions
source('../Rfunctions/TURN.R')
source('~/WebHub/AnalyticsWebHub/Rfunctions/createPaletteOfVariableLength.R')
head(a)
head(a)
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar()
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity')
with(a, spline(x=YearWeek, y=Runs, xmin=0))
with(a, spline(x=seq(1, length(YearWeek), 1), y=Runs, xmin=0))
b <- with(a, spline(x=seq(1, length(YearWeek), 1), y=Runs, xmin=0))
b
head(b)
b[[1]]
plot(x=b[[1]], y=b[[2]])
head(a)
a$Spline <- b[[2]]
b <- data.frame(x = b[[1]], y = b[[2]])
heaD(b)
head(b)
heaD(a)
head(a)
head(a)
head(b)
687/4
687/3
b[seq(0, length(b$x), 3), ]
d <- b[seq(0, length(b$x), 3), ]
b <- cbind(a, d)
head(b)
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=y), color='red', lwd=1.5, data=b)
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=y), color='red', lty=1.5, data=b)
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=y), color='red', size=1.5, data=b)
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Instruments), color='red', size=1.5, data=b)
dev.off()
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=y), color='red', size=1.5, data=b)
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=y, group=CustomerSiteId), color='red', size=1.5, data=b)
smooth.spline(x=a$YearWeek, y=a$Runs)
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs)
summary(smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs))
attributes(smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs))
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs)$y
a <- turn(runs.reg.date, 'CustomerSiteId', '7', calendar.df)
head(runs.reg.date)
a <- turn(runs.reg.date, 'CustomerSiteId', '7', calendar.df)
source('~/FilmArrayTrend/Rfunctions/TURN.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId', '7', calendar.df)
head(a)
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs)$y
a$Spline <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs)$y
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline, group=CustomerSiteId), data=b, lwd=1.5, color='red')
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline, group=CustomerSiteId), data=a, lwd=1.5, color='red')
rm(b, d)
a$Spline2 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=1)$y
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline2, group=CustomerSiteId), data=a, lwd=1.5, color='red')
a$Spline3 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.2)$y
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline3, group=CustomerSiteId), data=a, lwd=1.5, color='red')
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, lamba=1)$y
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, lambda=1)$y
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar = 2)
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar = 2)$y
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar = 0.1)$y
head(a)
a$Spline4 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.5)$y
head(a)
a$Spline5 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.3)$y
head(a)
head(a)
a$Runs
head(runs.df)
min(runs.df$Date)
min(runs.df[runs.df$CustomerSiteId==7, 'Runs'])
min(runs.df[runs.df$CustomerSiteId==7, 'Date'])
runs.df[runs.df$CustomerSiteId==7 & year(runs.df$Date)==2012, ]
head(a)
sapply(52:length(a$YearWeek), function(x) max(a[(x-51):x,'Runs'])/min(a[(x-51):x,'Runs']))
View(a)
96/9
sapply(52:length(a$YearWeek), function(x) max(a[(x-51):x,'Runs']))
sapply(52:length(a$YearWeek), function(x) a[x,'Runs']/min(a[(x-51):x,'Runs']))
lm(Runs~Instruments, data=a[1:52, ])
summary(lm(Runs~Instruments, data=a[1:52, ]))
head(a)
a$Runs - a$Spline
err.all <- c()
for(i in seq(0,1,0.1)) {
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=Runs, spar=i)$y
err <- (a$Runs - y)/a$Runs
err.all <- c(err.all, err)
}
head(a)
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=Runs, spar=0.1)$y
head(a)
err.all <- c()
for(i in seq(0,1,0.1)) {
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=i)$y
err <- (a$Runs - y)/a$Runs
err.all <- c(err.all, err)
}
err.all
err.all <- c()
for(i in seq(0,1,0.1)) {
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=i)$y
err <- sum(abs((a$Runs - y)/a$Runs))
err.all <- c(err.all, err)
}
err.all
i
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=i)$y
err <- sum(abs((a$Runs - y)/a$Runs))
err
y
a$Runs - y
(a$Runs - y)/a$Runs
abs((a$Runs - y)/a$Runs)
sum(!(is.infinite(abs((a$Runs - y)/a$Runs)))
)
sum(!(is.infinite(abs((a$Runs - y)/a$Runs))))
err.all <- c()
for(i in seq(0,1,0.1)) {
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=i)$y
err <- sum(!(is.infinite(abs((a$Runs - y)/a$Runs))))
err.all <- c(err.all, err)
}
err.all
y
s <- seq(0,1,0.1)
s
s <- seq(0,1,0.1)
err.all <- c()
for(in in 1:length(s)) {
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=s[i])$y
err <- sum(!(is.infinite(abs((a$Runs - y)/a$Runs))))
err.all <- c(err.all, err)
}
err.all <- c()
for(i in 1:length(s)) {
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=s[i])$y
err <- sum(!(is.infinite(abs((a$Runs - y)/a$Runs))))
err.all <- c(err.all, err)
}
err.all
print(i)
err.all <- c()
for(i in 1:length(s)) {
print(s[i])
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=s[i])$y
err <- sum(!(is.infinite(abs((a$Runs - y)/a$Runs))))
err.all <- c(err.all, err)
}
s <- seq(0,1,0.1)
err.all <- c()
for(i in 1:length(s)) {
print(s[i])
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=s[i])$y
err <- sum(!(is.infinite(abs((a$Runs - y)/a$Runs))))
print(err)
err.all <- c(err.all, err)
}
i <- 1
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=s[i])$y
y
i <- 2
y <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=s[i])$y
y
rm(err, err.all, y, s)
head(a)
a <- a[,1:6]
head(a)
a$S0 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0)$y
a$S1 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.1)$y
a$S2 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.2)$y
a$S3 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.3)$y
a$S4 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.4)$y
a$S5 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.5)$y
a$S6 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.6)$y
a$S7 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.7)$y
a$S8 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.8)$y
a$S9 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.9)$y
a$S10 <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=1)$y
head(a)
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=S0, group='0.0', color='0.0'), data=a) + geom_line(aes(x=YearWeek, y=S1, group='0.1', color='0.1'), data=a) + geom_line(aes(x=YearWeek, y=S2, group='0.2', color='0.2'), data=a) + geom_line(aes(x=YearWeek, y=S3, group='0.3', color='0.3'), data=a) + geom_line(aes(x=YearWeek, y=S4, group='0.4', color='0.4'), data=a) + geom_line(aes(x=YearWeek, y=S5, group='0.5', color='0.5'), data=a)
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=S0, group='0.0', color='0.0'), data=a, lwd=1.5) + geom_line(aes(x=YearWeek, y=S1, group='0.1', color='0.1'), data=a, lwd=1.5) + geom_line(aes(x=YearWeek, y=S2, group='0.2', color='0.2'), data=a, lwd=1.5) + geom_line(aes(x=YearWeek, y=S3, group='0.3', color='0.3'), data=a, lwd=1.5) + geom_line(aes(x=YearWeek, y=S4, group='0.4', color='0.4'), data=a, lwd=1.5) + geom_line(aes(x=YearWeek, y=S5, group='0.5', color='0.5'), data=a, lwd=1.5)
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.1)
mod <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=0.1)
predict(mod, x=seq(1, length(a$YearWeek), 1))
predict(mod, x=seq(1, length(a$YearWeek), 1))$y - a$Runs
s <- seq(0,1,0.1)
err.all <- c()
for(i in 1:length(s)) {
mod <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, spar=s[i])
res <- predict(mod, x=seq(1, length(a$YearWeek), 1))$y - a$Runs
err.all <- c(err.all, sum(res^2))
}
err.all
which(err.all==min(err.all))
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
head(a)
a$S1
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
summary(smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE))
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
a$S10
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$spar
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
a <- turn(runs.reg.date, 'CustomerSiteId', '7', calendar.df)
smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
a$Spline <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
heaD(a)
head(a)
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline, group=CustomerSiteId), data=a, lwd=1.5)
a <- turn(runs.reg.date, 'CustomerSiteId', '9', calendar.df)
a$Spline <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline, group=CustomerSiteId), data=a, lwd=1.5)
a <- turn(runs.reg.date, 'CustomerSiteId', '13', calendar.df)
a$Spline <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
ggplot(a, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline, group=CustomerSiteId), data=a, lwd=1.5)
b <- c()
for(i in 1:length(unique(runs.reg.date$CustomerSiteId))) {
a <- turn(runs.reg.date, 'CustomerSiteId', as.character(unique(runs.reg.date$CustomerSiteId)[i]), calendar.df)
a$Spline <- smooth.spline(x=seq(1, length(a$YearWeek), 1), y=a$Runs, cv = FALSE)$y
a[a$Spline<0, 'Spline'] <- 0
b <- rbind(b, a)
}
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline, group=CustomerSiteId), data=b, lwd=1.5) + facet_wrap(~CustomerSiteId)
ggplot(b, aes(x=YearWeek, y=Runs)) + geom_bar(stat='identity') + geom_line(aes(x=YearWeek, y=Spline, group=CustomerSiteId), data=b, lwd=1.5) + facet_wrap(~CustomerSiteId, scale='free_y')
