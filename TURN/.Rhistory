axis_idx <- as.numeric(which(sapply(ga,function(x) !is.null(x$children$axis))))
for(i in 1:length(axis_idx)){
ax <- ga[[axis_idx[i]]]$children$axis
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia[axis_idx[i]], ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t[axis_idx[i]], length(g$widths) - i, pp$b[axis_idx[i]])
}
g$grobs[[which(g$layout$name =='ylab-r')]] <- g2$grobs[[which(g2$layout$name =='ylab-l')]] # add the axis label from p2 to the right side of the plot
g$layout$r[[which(g$layout$name =='background')]] <- g$layout$r[[which(g$layout$name =='background')]] + 1
g
g$layout
g$layout$l[[which(g$layout$name =='ylab-r')]] <- g$layout$l[[which(g$layout$name =='ylab-r')]] + 3
g$layout$r[[which(g$layout$name =='ylab-r')]] <- g$layout$r[[which(g$layout$name =='ylab-r')]] + 3
grid.newpage()
grid.draw(g)
g <- gtable_add_grob(g1, g2$grobs[grep("panel",g2$layout$name)], pp$t, pp$l, pp$b, pp$l)
# axis tweaks
ia <- which(grepl("axis_l",g2$layout$name) |  grepl("axis-l",g2$layout$name)     )
ga <- g2$grobs[ia]
axis_idx <- as.numeric(which(sapply(ga,function(x) !is.null(x$children$axis))))
for(i in 1:length(axis_idx)){
ax <- ga[[axis_idx[i]]]$children$axis
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia[axis_idx[i]], ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t[axis_idx[i]], length(g$widths) - i, pp$b[axis_idx[i]])
}
g$grobs[[which(g$layout$name =='ylab-r')]] <- g2$grobs[[which(g2$layout$name =='ylab-l')]] # add the axis label from p2 to the right side of the plot
# g$layout$r[[which(g$layout$name =='background')]] <- g$layout$r[[which(g$layout$name =='background')]] + 1
g$layout$l[[which(g$layout$name =='ylab-r')]] <- g$layout$l[[which(g$layout$name =='ylab-r')]] + 3
g$layout$r[[which(g$layout$name =='ylab-r')]] <- g$layout$r[[which(g$layout$name =='ylab-r')]] + 3
# Plot!
grid.newpage()
grid.draw(g)
p1 <- ggplot(ili.turn.mrg, aes(x=YearWeek, y=Rate, color='ILI (CDC)', group='ILI (CDC)')) + geom_line(data=ili.turn.mrg, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(lwd=1.5) + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(color='transparent', fill='white'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + labs(y='ILI (%)', x='Date') + scale_color_manual(values=c('black','red')) + facet_wrap(~CensusRegionNational)
p2 <- ggplot(ili.turn.mrg, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(color='red') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(fill='transparent', color='transparent'), panel.grid=element_blank(), axis.ticks.x=element_blank(), axis.text.y=element_blank()) + scale_x_discrete(breaks = dateBreaks[5:length(dateBreaks)], labels = dateBreaks[5:length(dateBreaks)]) + labs(y='') + facet_wrap(~CensusRegionNational)
## Putting plots together ##################
# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))
# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, grepl("panel",name) , se = t:r))
g <- gtable_add_grob(g1, g2$grobs[grep("panel",g2$layout$name)], pp$t, pp$l, pp$b, pp$l)
# axis tweaks
ia <- which(grepl("axis_l",g2$layout$name) |  grepl("axis-l",g2$layout$name)     )
ga <- g2$grobs[ia]
axis_idx <- as.numeric(which(sapply(ga,function(x) !is.null(x$children$axis))))
for(i in 1:length(axis_idx)){
ax <- ga[[axis_idx[i]]]$children$axis
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia[axis_idx[i]], ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t[axis_idx[i]], length(g$widths) - i, pp$b[axis_idx[i]])
}
g$grobs[[which(g$layout$name =='ylab-r')]] <- g2$grobs[[which(g2$layout$name =='ylab-l')]] # add the axis label from p2 to the right side of the plot
# g$layout$r[[which(g$layout$name =='background')]] <- g$layout$r[[which(g$layout$name =='background')]] + 1
# g$layout$l[[which(g$layout$name =='ylab-r')]] <- g$layout$l[[which(g$layout$name =='ylab-r')]] + 3
# g$layout$r[[which(g$layout$name =='ylab-r')]] <- g$layout$r[[which(g$layout$name =='ylab-r')]] + 3
# Plot!
grid.newpage()
grid.draw(g)
p1 <- ggplot(ili.turn.mrg, aes(x=YearWeek, y=Rate, color='ILI (CDC)', group='ILI (CDC)')) + geom_line(data=ili.turn.mrg, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(lwd=1.5) + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(color='transparent', fill='white'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + labs(y='ILI (%)', x='Date') + scale_color_manual(values=c('black','red')) + facet_wrap(~CensusRegionNational)
p2 <- ggplot(ili.turn.mrg, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(color='red') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(fill='transparent', color='transparent'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + scale_x_discrete(breaks = dateBreaks[5:length(dateBreaks)], labels = dateBreaks[5:length(dateBreaks)]) + labs(y='') + facet_wrap(~CensusRegionNational)
## Putting plots together ##################
# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))
# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, grepl("panel",name) , se = t:r))
g <- gtable_add_grob(g1, g2$grobs[grep("panel",g2$layout$name)], pp$t, pp$l, pp$b, pp$l)
# axis tweaks
ia <- which(grepl("axis_l",g2$layout$name) |  grepl("axis-l",g2$layout$name)     )
ga <- g2$grobs[ia]
axis_idx <- as.numeric(which(sapply(ga,function(x) !is.null(x$children$axis))))
for(i in 1:length(axis_idx)){
ax <- ga[[axis_idx[i]]]$children$axis
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia[axis_idx[i]], ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t[axis_idx[i]], length(g$widths) - i, pp$b[axis_idx[i]])
}
g$grobs[[which(g$layout$name =='ylab-r')]] <- g2$grobs[[which(g2$layout$name =='ylab-l')]] # add the axis label from p2 to the right side of the plot
# g$layout$r[[which(g$layout$name =='background')]] <- g$layout$r[[which(g$layout$name =='background')]] + 1
# g$layout$l[[which(g$layout$name =='ylab-r')]] <- g$layout$l[[which(g$layout$name =='ylab-r')]] + 3
# g$layout$r[[which(g$layout$name =='ylab-r')]] <- g$layout$r[[which(g$layout$name =='ylab-r')]] + 3
# Plot!
grid.newpage()
grid.draw(g)
grid.newpage()
png('Figures/RegionalOverlayOfILIandTURN.png', height=800, width=1400)
grid.draw(g)
dev.off()
head(bugs.df)
head(runs.reg.date)
merge(bugs.df, runs.reg.date[,c('RunDataId','YearWeek')], by='RunDataId')
head(runs.reg.date)
merge(bugs.df, runs.reg.date[,c('RunDataId','YearWeek','CustomerSiteId')], by='RunDataId')
bugs.df <- merge(bugs.df, runs.reg.date[,c('RunDataId','YearWeek','CustomerSiteId')], by='RunDataId')
head(bugs.df)
expand.grid(YearWeek = unique(calendar.df$YearWeek), CustomerSiteId = unique(bugs.df$CustomerSiteId), Target = unique(bugs.df$Target))
bugs.base <- expand.grid(YearWeek = unique(calendar.df$YearWeek), CustomerSiteId = unique(bugs.df$CustomerSiteId), Target = unique(bugs.df$Target))
head(bugs.base)
head(bugs.df)
bugs.agg <- with(bugs.df, aggregate(Positive~YearWeek+CustomerSiteId+Target, FUN=sum))
head(bugs.base)
head(bugs.agg)
site.bugs <- merge(bugs.base, bugs.agg, by=c('YearWeek','CustomerSiteId','Target'), all.x=TRUE)
head(site.bugs)
site.bugs[is.na(site.bugs$Positive), 'Positive'] <- 0
head(site.bugs)
unique(site.bugs$Target)
sites
site.bugs <- site.bugs[with(site.bugs, order(CustomerSiteId, YearWeek, Target))]
site.bugs <- site.bugs[with(site.bugs, order(CustomerSiteId, YearWeek, Target)),]
bugs <- as.character(unique(site.bugs$Target))
year.weeks <- as.character(unique(site.bugs$YearWeek))
sites[order(sites)]
sites[order(as.numeric(sites))]
sites <- sites[order(as.numeric(sites))]
a <- do.call(rbind, lapply(1:length(sites), function(x) do.call(rbind, lapply(1:length(bugs), function(y) do.call(rbind, function(z) 2:(length(year.weeks)-1) data.frame(YearWeek = year.weeks[z], CustomerSiteId = sites[x], Target = bugs[y], Positives = sum(site.bugs[site.bugs$CustomerSiteId==sites[x] & site.bugs$Target==bugs[y], 'Positive'][(z-1):(z+1)])))))))
a <- do.call(rbind, lapply(1:length(sites), function(x) do.call(rbind, lapply(1:length(bugs), function(y) do.call(rbind, lapply(2:(length(year.weeks)-1), function(z) data.frame(YearWeek = year.weeks[z], CustomerSiteId = sites[x], Target = bugs[y], Positives = sum(site.bugs[site.bugs$CustomerSiteId==sites[x] & site.bugs$Target==bugs[y], 'Positive'][(z-1):(z+1)])))))))
a <- do.call(rbind, lapply(1:length(sites), function(x) do.call(rbind, lapply(1:length(bugs), function(y) do.call(rbind, lapply(2:(length(year.weeks)-1), function(z) data.frame(YearWeek = year.weeks[z], CustomerSiteId = sites[x], Target = bugs[y], Positives = sum(site.bugs[site.bugs$CustomerSiteId==sites[x] & site.bugs$Target==bugs[y], 'Positive'][(z-1):(z+1)]))))))))
a <- do.call(rbind, lapply(1:2, function(x) do.call(rbind, lapply(1:length(bugs), function(y) do.call(rbind, lapply(2:(length(year.weeks)-1), function(z) data.frame(YearWeek = year.weeks[z], CustomerSiteId = sites[x], Target = bugs[y], Positives = sum(site.bugs[site.bugs$CustomerSiteId==sites[x] & site.bugs$Target==bugs[y], 'Positive'][(z-1):(z+1)]))))))))
a <- do.call(rbind, lapply(1:2, function(x) do.call(rbind, lapply(1:2, function(y) do.call(rbind, lapply(2:(length(year.weeks)-1), function(z) data.frame(YearWeek = year.weeks[z], CustomerSiteId = sites[x], Target = bugs[y], Positives = sum(site.bugs[site.bugs$CustomerSiteId==sites[x] & site.bugs$Target==bugs[y], 'Positive'][(z-1):(z+1)]))))))))
View(a)
head(site.bugs)
head(site.bugs[site.bugs$CustomerSiteId==2 & site.bugs$Target=='Adenovirus', ])
length(year.weeks)
length(year.weeks)*2*2
length(year.weeks)*2*2-(4*2)
site.bugs[site.bugs$CustomerSiteId==2 & site.bugs$Target=='Adenovirus', ]
p1 <- ggplot(ili.turn.mrg, aes(x=YearWeek, y=Rate, color='ILI (CDC)', group='ILI (CDC)')) + geom_line(data=ili.turn.mrg, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(lwd=1.5) + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(color='transparent', fill='white'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + labs(y='ILI (%)', x='Date') + scale_color_manual(values=c('black','red'), name='') + facet_wrap(~CensusRegionNational)
p2 <- ggplot(ili.turn.mrg, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(color='red') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(fill='transparent', color='transparent'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + scale_x_discrete(breaks = dateBreaks[5:length(dateBreaks)], labels = dateBreaks[5:length(dateBreaks)]) + labs(y='') + facet_wrap(~CensusRegionNational)
## Putting plots together ##################
# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))
# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, grepl("panel",name) , se = t:r))
g <- gtable_add_grob(g1, g2$grobs[grep("panel",g2$layout$name)], pp$t, pp$l, pp$b, pp$l)
# axis tweaks
ia <- which(grepl("axis_l",g2$layout$name) |  grepl("axis-l",g2$layout$name)     )
ga <- g2$grobs[ia]
axis_idx <- as.numeric(which(sapply(ga,function(x) !is.null(x$children$axis))))
for(i in 1:length(axis_idx)){
ax <- ga[[axis_idx[i]]]$children$axis
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia[axis_idx[i]], ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t[axis_idx[i]], length(g$widths) - i, pp$b[axis_idx[i]])
}
g$grobs[[which(g$layout$name =='ylab-r')]] <- g2$grobs[[which(g2$layout$name =='ylab-l')]] # add the axis label from p2 to the right side of the plot
# g$layout$r[[which(g$layout$name =='background')]] <- g$layout$r[[which(g$layout$name =='background')]] + 1
# g$layout$l[[which(g$layout$name =='ylab-r')]] <- g$layout$l[[which(g$layout$name =='ylab-r')]] + 3
# g$layout$r[[which(g$layout$name =='ylab-r')]] <- g$layout$r[[which(g$layout$name =='ylab-r')]] + 3
# Plot!
grid.newpage()
png('Figures/RegionalOverlayOfILIandTURN.png', height=800, width=1400)
grid.draw(g)
dev.off()
site.bugs.roll <- do.call(rbind, lapply(1:length(sites), function(x) do.call(rbind, lapply(1:length(bugs), function(y) do.call(rbind, function(z) 2:(length(year.weeks)-1) data.frame(YearWeek = year.weeks[z], CustomerSiteId = sites[x], Target = bugs[y], Positives = sum(site.bugs[site.bugs$CustomerSiteId==sites[x] & site.bugs$Target==bugs[y], 'Positive'][(z-1):(z+1)])))))))
site.bugs.roll <- do.call(rbind, lapply(1:length(sites), function(x) do.call(rbind, lapply(1:length(bugs), function(y) do.call(rbind, lapply(2:(length(year.weeks)-1), function(z) data.frame(YearWeek = year.weeks[z], CustomerSiteId = sites[x], Target = bugs[y], Positives = sum(site.bugs[site.bugs$CustomerSiteId==sites[x] & site.bugs$Target==bugs[y], 'Positive'][(z-1):(z+1)]))))))))
head(site.bugs.roll)
head(site.turn)
a <- merge(site.bugs.roll, site.turn[,c('YearWeek','CustomerSiteId','SpecRuns')], by=c('YearWeek','CustomerSiteId'))
head(a)
head(names.df)
site.prev <- merge(site.bugs.roll, site.turn[,c('YearWeek','CustomerSiteId','SpecRuns')], by=c('YearWeek','CustomerSiteId'))
regn.prev <- merge(site.prev, names.df[,c('CustomerSiteId','CensusRegionNational')], by='CustomerSiteId')
head(site.prev)
head(regn.prev)
site.prev$Detection <- with(site.prev, Positives/SpecRuns)
regn.prev <- merge(site.prev, names.df[,c('CustomerSiteId','CensusRegionNational')], by='CustomerSiteId')
regn.prev <- with(regn.prev, aggregate(Detection~YearWeek+CensusRegionNational+Positives, FUN=mean))
head(regn.prev)
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=Target))
regn.prev <- merge(site.prev, names.df[,c('CustomerSiteId','CensusRegionNational')], by='CustomerSiteId')
regn.prev <- with(regn.prev, aggregate(Detection~YearWeek+CensusRegionNational+Target, FUN=mean))
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=Target, group=Target))
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=Target, group=Target)) + facet_wrap(~CensusRegionNational)
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=Target, group=Target)) + facet_wrap(~CensusRegionNational) + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'Target'))
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=Target, group=Target), stat='identity', position='stack') + facet_wrap(~CensusRegionNational) + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'Target'))
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=Target, group=Target), stat='identity', position='stack') + facet_wrap(~CensusRegionNational) + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'Target')) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,1), labels=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + guides(fill=guide_legend(ncol=7, bycol=TRUE)) + labs(title='', y='Detection (%)', x='Date')
natn.prev <- with(site.prev, aggregate(Detection~YearWeek+Target, FUN=mean))
ggplot(natn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=Target, group=Target), stat='identity', position='stack') + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'Target')) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,1), labels=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + guides(fill=guide_legend(ncol=7, bycol=TRUE)) + labs(title='', y='Detection (%)', x='Date')
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- readLines('../DataSources/ShortNames.sql')
query <- paste(queryVector,collapse="\n")
abvs.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
abvs.df
site.prev <- merge(site.bugs.roll, site.turn[,c('YearWeek','CustomerSiteId','SpecRuns')], by=c('YearWeek','CustomerSiteId'))
head(site.prev)
head(abvs.df)
a <- merge(site.prev, abvs.df, by.x='Target', by.y='Organism')
nrow(site.prev)
nrow(a)
rm(a)
site.prev <- merge(site.bugs.roll, site.turn[,c('YearWeek','CustomerSiteId','SpecRuns')], by=c('YearWeek','CustomerSiteId'))
site.prev <- merge(site.prev, abvs.df, by.x='Target', by.y='Organism')
site.prev$Detection <- with(site.prev, Positives/SpecRuns)
regn.prev <- merge(site.prev, names.df[,c('CustomerSiteId','CensusRegionNational')], by='CustomerSiteId')
regn.prev <- merge(site.prev, names.df[,c('CustomerSiteId','CensusRegionNational')], by='CustomerSiteId')
regn.prev <- with(regn.prev, aggregate(Detection~YearWeek+CensusRegionNational+Target+ShortName, FUN=mean))
natn.prev <- with(site.prev, aggregate(Detection~YearWeek+Target+ShortName, FUN=mean))
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=ShortName, group=ShortName), stat='identity', position='stack') + facet_wrap(~CensusRegionNational) + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'ShortName')) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,1), labels=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + guides(fill=guide_legend(ncol=7, bycol=TRUE)) + labs(title='', y='Detection (%)', x='Date')
ggplot(natn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=ShortName, group=ShortName), stat='identity', position='stack') + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'ShortName')) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,1), labels=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + guides(fill=guide_legend(ncol=7, bycol=TRUE)) + labs(title='', y='Detection (%)', x='Date')
site.prev[site.prev$SpecRuns < 30, ]
site.prev <- merge(site.bugs.roll, site.turn[,c('YearWeek','CustomerSiteId','SpecRuns')], by=c('YearWeek','CustomerSiteId'))
site.prev <- merge(site.prev, abvs.df, by.x='Target', by.y='Organism')
site.prev$Detection <- with(site.prev, Positives/SpecRuns)
site.prev[site.prev$SpecRuns < 30, 'Detection'] <- NA
regn.prev <- merge(site.prev, names.df[,c('CustomerSiteId','CensusRegionNational')], by='CustomerSiteId')
regn.prev <- with(regn.prev, aggregate(Detection~YearWeek+CensusRegionNational+Target+ShortName, FUN=mean))
natn.prev <- with(site.prev, aggregate(Detection~YearWeek+Target+ShortName, FUN=mean))
ggplot(regn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=ShortName, group=ShortName), stat='identity', position='stack') + facet_wrap(~CensusRegionNational) + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'ShortName'), name='') + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,1), labels=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + guides(fill=guide_legend(ncol=7, bycol=TRUE)) + labs(title='', y='Detection (%)', x='Date')
ggplot(natn.prev, aes(x=YearWeek)) + geom_area(aes(y=Detection, fill=ShortName, group=ShortName), stat='identity', position='stack') + scale_fill_manual(values=createPaletteOfVariableLength(regn.prev, 'ShortName'), name='') + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,1), labels=c(0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100), breaks=c(0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + guides(fill=guide_legend(ncol=7, bycol=TRUE)) + labs(title='', y='Detection (%)', x='Date')
grid.draw(g)
ili.turn.mrg.nat <- merge(natn.turn, cdc.trend.rate.nat, by=c('YearWeek'), all.x=TRUE)
ggplot(ili.turn.mrg.nat, aes(x=YearWeek, y=Rate, color='ILI (CDC)', group='ILI (CDC)')) + geom_line(data=ili.turn.mrg, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(lwd=1.5) + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(color='transparent', fill='white'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + labs(y='ILI (%)', x='Date') + scale_color_manual(values=c('black','red'), name='')
ggplot(ili.turn.mrg.nat, aes(x=YearWeek, y=Rate, color='ILI (CDC)', group='ILI (CDC)')) + geom_line(data=ili.turn.mrg.nat, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(lwd=1.5) + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(color='transparent', fill='white'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + labs(y='ILI (%)', x='Date') + scale_color_manual(values=c('black','red'), name='')
p1 <- ggplot(ili.turn.mrg.nat, aes(x=YearWeek, y=Rate, color='ILI (CDC)', group='ILI (CDC)')) + geom_line(data=ili.turn.mrg.nat, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(lwd=1.5) + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(color='transparent', fill='white'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + labs(y='ILI (%)', x='Date') + scale_color_manual(values=c('black','red'), name='')
p2 <- ggplot(ili.turn.mrg.nat, aes(x=YearWeek, y=TURN/100, color='TURN', group='TURN'), lwd=1.5) + geom_line(color='red') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + scale_y_continuous(limits=c(0, 0.08), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1), legend.position='bottom', panel.background=element_rect(fill='transparent', color='transparent'), panel.grid=element_blank(), axis.ticks.x=element_blank()) + scale_x_discrete(breaks = dateBreaks[5:length(dateBreaks)], labels = dateBreaks[5:length(dateBreaks)]) + labs(y='')
## Putting plots together ##################
# extract gtable
g1 <- ggplot_gtable(ggplot_build(p1))
g2 <- ggplot_gtable(ggplot_build(p2))
# overlap the panel of 2nd plot on that of 1st plot
pp <- c(subset(g1$layout, grepl("panel",name) , se = t:r))
g <- gtable_add_grob(g1, g2$grobs[grep("panel",g2$layout$name)], pp$t, pp$l, pp$b, pp$l)
# axis tweaks
ia <- which(grepl("axis_l",g2$layout$name) | grepl("axis-l",g2$layout$name))
ga <- g2$grobs[ia]
axis_idx <- as.numeric(which(sapply(ga,function(x) !is.null(x$children$axis))))
for(i in 1:length(axis_idx)){
ax <- ga[[axis_idx[i]]]$children$axis
ax$widths <- rev(ax$widths)
ax$grobs <- rev(ax$grobs)
ax$grobs[[1]]$x <- ax$grobs[[1]]$x - unit(1, "npc") + unit(0.15, "cm")
g <- gtable_add_cols(g, g2$widths[g2$layout[ia[axis_idx[i]], ]$l], length(g$widths) - 1)
g <- gtable_add_grob(g, ax, pp$t[axis_idx[i]], length(g$widths) - i, pp$b[axis_idx[i]])
}
g$grobs[[which(g$layout$name =='ylab-r')]] <- g2$grobs[[which(g2$layout$name =='ylab-l')]] # add the axis label from p2 to the right side of the plot
# g$layout$r[[which(g$layout$name =='background')]] <- g$layout$r[[which(g$layout$name =='background')]] + 1
# g$layout$l[[which(g$layout$name =='ylab-r')]] <- g$layout$l[[which(g$layout$name =='ylab-r')]] + 3
# g$layout$r[[which(g$layout$name =='ylab-r')]] <- g$layout$r[[which(g$layout$name =='ylab-r')]] + 3
# Plot!
grid.newpage()
png('Figures/NationalOverlayOfILIandTURN.png', height=800, width=1400)
grid.draw(g)
dev.off()
head(cdc.flu.df)
head(cdc.ili.df)
head(goog.flu.df)
grep('Region', colnames(goog.flu.df))
colnames(goog.flu.df)[grep('Region', colnames(goog.flu.df))]
colnames(goog.flu.df)[grep('Region', colnames(goog.flu.df))] <- 'hhsRegion'
sum(cdc.flu.df[,4:ncol(cdc.flu.df)])
sapply(1:nrow(cdc.flu.df), function(x) sum(cdc.flu.df[x,4:ncol(cdc.flu.df)]))
goog.flu.df$Rate <- goog.flu.df$Rate/100
cdc.flu.df$TotalFlu <- sapply(1:nrow(cdc.flu.df), function(x) sum(cdc.flu.df[x,4:ncol(cdc.flu.df)]))
head(cdc.flu.df)
head(goog.flu.df)
head(cdc.ili.df)
cdc.flu.df$fluRate <- with(cdc.flu.df, TotalFlu/TotalObs)
head(site.turn)
head(names)
head(names.df)
comp.df <- merge(merge(cdc.ili.df, cdc.flu.df, by=c('YearWeek','hhsRegion')), goog.flu.df, by=c('YearWeek','hhsRegion'))
head(comp.df)
head(site.turn)
head(regions.df)
FADWcxn <- odbcConnect(dsn = 'FA_DW', uid = 'afaucett', pwd = 'ThisIsAPassword-BAD')
queryVector <- readLines('../DataSources/CustomerSiteIdsWithNames.sql')
query <- paste(queryVector,collapse="\n")
names.df <- sqlQuery(FADWcxn,query)
odbcClose(FADWcxn)
merge(site.turn[,c('YearWeek','CustomerSiteId','TURN')], names.df[,c('CustomerSiteId','hhsRegion')], by='CustomerSiteId')
hhs.turn <- merge(site.turn[,c('YearWeek','CustomerSiteId','TURN')], names.df[,c('CustomerSiteId','hhsRegion')], by='CustomerSiteId')
head(hhs.turn)
with(hhs.turn, aggregate(TURN~YearWeek+hhsRegion, FUN=mean))
hhs.turn <- with(hhs.turn, aggregate(TURN~YearWeek+hhsRegion, FUN=mean))
comp.df <- merge(comp.df, hhs.turn, by=c('YearWeek','hhsRegion'), all.x=TRUE)
head(comp.df)
ggplot(comp.df, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line() + geom_line(aes(x=YearWeek, y=fluRate, group='CDC Flu', color='CDC Flu'), data=comp.df) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.df) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.df)
ggplot(comp.df, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line() + geom_line(aes(x=YearWeek, y=fluRate, group='CDC Flu', color='CDC Flu'), data=comp.df) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.df) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.df) + facet_wrap(~hhsRegion)
ggplot(comp.df, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line() + geom_line(aes(x=YearWeek, y=fluRate/5, group='CDC Flu', color='CDC Flu'), data=comp.df) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.df) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.df) + facet_wrap(~hhsRegion)
unique(hhs.turn)
unique(hhs.turn$hhsRegion)
comp.trim <- comp.df[comp.df$hhsRegion %in% c(1, 2, 4, 5, 7, 8), ]
ggplot(comp.trim, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line() + geom_line(aes(x=YearWeek, y=fluRate, group='CDC Flu', color='CDC Flu'), data=comp.trim) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.trim) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.trim) + facet_wrap(~hhsRegion)
ggplot(comp.trim, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line() + geom_line(aes(x=YearWeek, y=fluRate/5, group='CDC Flu', color='CDC Flu'), data=comp.trim) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.trim) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.trim) + facet_wrap(~hhsRegion)
ggplot(comp.trim, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line(lwd=1.5) + geom_line(aes(x=YearWeek, y=fluRate/5, group='CDC Flu', color='CDC Flu'), data=comp.trim, lwd=1.5) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.trim, lwd=1.5) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.trim, lwd=1.5) + facet_wrap(~hhsRegion) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,0.1), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank())
ggplot(comp.trim, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line(lwd=1.5) + geom_line(aes(x=YearWeek, y=fluRate/5, group='CDC Flu', color='CDC Flu'), data=comp.trim, lwd=1.5) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.trim, lwd=1.5) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.trim, lwd=1.5) + facet_wrap(~hhsRegion) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,0.1), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + scale_color_manual(values=c('black','darkgreen','blue','red'))
ggplot(comp.trim, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line(lwd=1.5) + geom_line(aes(x=YearWeek, y=fluRate/5, group='CDC Flu', color='CDC Flu'), data=comp.trim, lwd=1.5) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.trim, lwd=1.5) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.trim, lwd=1.5) + facet_wrap(~hhsRegion) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,0.1), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + scale_color_manual(values=c('black','darkgreen','blue','red'), name='')
ggplot(comp.trim, aes(x=YearWeek, y=iliRate, group='ILI', color='ILI')) + geom_line(lwd=1.5) + geom_line(aes(x=YearWeek, y=fluRate/5, group='CDC Flu', color='CDC Flu'), data=comp.trim, lwd=1.5) + geom_line(aes(x=YearWeek, y=Rate, group='Google Flu', color='Google Flu'), data=comp.trim, lwd=1.5) +  geom_line(aes(x=YearWeek, y=TURN/100, group='TURN', color='TURN'), data=comp.trim, lwd=1.5) + facet_wrap(~hhsRegion) + scale_x_discrete(breaks=dateBreaks, labels=dateLabels) + scale_y_continuous(limits=c(0,0.1), labels=c(0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10), breaks=c(0, 0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.1)) + theme(plot.title=element_text(hjust=0.5),text=element_text(size=22, face='bold'), axis.text=element_text(size=22, color='black', face='bold'), axis.text.x=element_text(angle=90, hjust=1, vjust=0.5), legend.position='bottom', panel.background=element_rect(color='white', fill='white'), axis.ticks.x=element_blank()) + scale_color_manual(values=c('black','darkgreen','blue','red'), name='') + labs(y='Google Flu (%), ILI (%), TURN', x='')
ggplot(site.turn, aes(x=YearWeek, y=TURN, group='SiteTURN', color='SiteTURN')) + geom_line(size=1.5) + geom_line(aes(x=YearWeek, y=TURN, group='NationalTURN', color='NationalTURN'), data=natn.turn, size=1.5) + scale_color_manual(values=c('black','blue')) + facet_wrap(~CustomerSiteId, scale='free_y') + labs(title='TURN_v1')
# load libraries
library(RODBC)
library(lubridate)
library(xlsx)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
library(RColorBrewer)
library(devtools)
library(dplyr)
library(tidyr)
require(dateManip)
# load custom functions
source('../Rfunctions/TURN_v4.R')
source('~/WebHub/AnalyticsWebHub/Rfunctions/createPaletteOfVariableLength.R')
workDir <-'~/FilmArrayTrend/TURN/'
setwd(workDir)
# load libraries
library(RODBC)
library(lubridate)
library(xlsx)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
library(RColorBrewer)
library(devtools)
library(dplyr)
library(tidyr)
require(dateManip)
# load custom functions
source('../Rfunctions/TURN_v4.R')
source('../Rfunctions/TURN_v3.R')
ggplot(site.turn, aes(x=YearWeek, y=TURN, group='SiteTURN', color='SiteTURN')) + geom_line(size=1.5) + geom_line(aes(x=YearWeek, y=TURN, group='NationalTURN', color='NationalTURN'), data=natn.turn, size=1.5) + scale_color_manual(values=c('black','blue')) + facet_wrap(~CustomerSiteId, scale='free_y') + labs(title='TURN_v1')
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- do.call(rbind, lapply(1:length(sites), function(x) turn(runs.reg.date, 'CustomerSiteId', sites[x], 'RP', calendar.df, 30)))
head(a)
View(a)
View(a)
View(a)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
turn(runs.reg.date, 'CustomerSiteId','24','RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId','24','RP', calendar.df, 30)
View(a)
a[a$Gap==0, ]
quantile(a[a$Gap==0, ], probs=0.10)
quantile(a[a$Gap==0, 'SpecRuns'], probs=0.10)
lm(SpecRuns~Runs, a)
summary(lm(SpecRuns~Runs, a))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
ggplot(site.turn, aes(x=YearWeek, y=TURN, group='SiteTURN', color='SiteTURN')) + geom_line(size=1.5) + geom_line(aes(x=YearWeek, y=TURN, group='NationalTURN', color='NationalTURN'), data=natn.turn, size=1.5) + scale_color_manual(values=c('black','blue')) + facet_wrap(~CustomerSiteId, scale='free_y') + labs(title='TURN_v3') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels)
ggplot(site.turn, aes(x=YearWeek, y=TURN, group='SiteTURN', color='SiteTURN')) + geom_line(size=1.5) + geom_line(aes(x=YearWeek, y=TURN, group='NationalTURN', color='NationalTURN'), data=natn.turn, size=1.5) + scale_color_manual(values=c('black','blue')) + facet_wrap(~CustomerSiteId, scale='free_y') + labs(title='TURN_v3') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + theme(axis.text.x=element_text(angle=90, hjust=1))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
warnings()
a
head(runs.reg.date)
head(a)
b <- with(runs.reg.date[runs.reg.date$CustomerSiteId==5 & runs.reg.date$Panel=='RP', ], aggregate(Run~YearWeek, FUN=sum))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
b <- with(runs.reg.date[runs.reg.date$CustomerSiteId==5 & runs.reg.date$Panel=='RP', ], aggregate(Run~YearWeek, FUN=sum))
head(a)
head(b)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
b <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
head(a)
head(b)
ggplot(a, aes(x=YearWeek, y=Runs, group='Runs', color='Runs')) + geom_line(lwd=1.5) + geom_line(data=a, aes(x=YearWeek, y=SpecRuns, group='RP Runs', color='RP Runs'), lwd=1.5)  + geom_line(data=a, aes(x=YearWeek, y=SpecPositives, group='RP Positives', color='RP Positives'), lwd=1.5) + geom_line(data=b, aes(x=YearWeek, y=TURN, group='TURN', color='TURN'), lwd=1.5) + scale_color_manual(values=c('blue','purple','black','red'))
ggplot(a, aes(x=YearWeek, y=Runs, group='Runs', color='Runs')) + geom_line(lwd=1.5) + geom_line(data=a, aes(x=YearWeek, y=SpecRuns, group='RP Runs', color='RP Runs'), lwd=1.5)  + geom_line(data=a, aes(x=YearWeek, y=SpecPositives, group='RP Positives', color='RP Positives'), lwd=1.5) + geom_line(data=b, aes(x=YearWeek, y=30*TURN, group='TURN', color='TURN'), lwd=1.5) + scale_color_manual(values=c('blue','purple','black','red'))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
b <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
b
head(a)
View(a)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- do.call(rbind, lapply(1:length(sites), function(x) turn(runs.reg.date, 'CustomerSiteId', sites[x], 'RP', calendar.df, 30)))
head(a)
b <- with(a, aggregate(TURN~YearWeek, FUN=mean))
ggplot(a, aes(x=YearWeek, y=TURN, group='SiteTURN', color='SiteTURN')) + geom_line(size=1.5) + geom_line(aes(x=YearWeek, y=TURN, group='NationalTURN', color='NationalTURN'), data=b, size=1.5) + scale_color_manual(values=c('black','blue')) + facet_wrap(~CustomerSiteId, scale='free_y') + labs(title='TURN_v3') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + theme(axis.text.x=element_text(angle=90, hjust=1))
ggplot(a, aes(x=YearWeek, y=TURN, group='SiteTURN', color='SiteTURN')) + geom_line(size=1.5) + geom_line(aes(x=YearWeek, y=TURN, group='NationalTURN', color='NationalTURN'), data=b, size=1.5) + scale_color_manual(values=c('black','blue')) + facet_wrap(~CustomerSiteId, scale='free_y') + labs(title='TURN_omega') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + theme(axis.text.x=element_text(angle=90, hjust=1))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- do.call(rbind, lapply(1:length(sites), function(x) turn(runs.reg.date, 'CustomerSiteId', sites[x], 'RP', calendar.df, 30)))
b <- with(a, aggregate(TURN~YearWeek, FUN=mean))
ggplot(a, aes(x=YearWeek, y=TURN, group='SiteTURN', color='SiteTURN')) + geom_line(size=1.5) + geom_line(aes(x=YearWeek, y=TURN, group='NationalTURN', color='NationalTURN'), data=b, size=1.5) + scale_color_manual(values=c('black','blue')) + facet_wrap(~CustomerSiteId, scale='free_y') + labs(title='TURN_omega_adj') + scale_x_discrete(breaks = dateBreaks, labels = dateLabels) + theme(axis.text.x=element_text(angle=90, hjust=1))
head(a)
View(a)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId', '7', 'RP', calendar.df, 30)
warnings()
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
f <- turn(runs.reg.date, 'CustomerSiteId', '7', 'RP', calendar.df, 30)
head(d)
head(f)
ggplot(d, aes(x=YearWeek, y=TURN, group=1)) + geom_line(color='black', lwd=1.5) + geom_line(f, aes(x=YearWeek, y=TURN, group=2), color='blue', lwd=1.5)
ggplot(d, aes(x=YearWeek, y=TURN, group=1)) + geom_line(color='black', lwd=1.5) + geom_line(data=f, aes(x=YearWeek, y=TURN, group=2), color='blue', lwd=1.5)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId', '7', 'RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
f <- turn(runs.reg.date, 'CustomerSiteId', '7', 'RP', calendar.df, 30)
f <- turn(runs.reg.date, 'CustomerSiteId', '5', 'RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId', '5', 'RP', calendar.df, 30)
ggplot(d, aes(x=YearWeek, y=TURN, group=1)) + geom_line(color='black', lwd=1.5) + geom_line(data=f, aes(x=YearWeek, y=TURN, group=2), color='blue', lwd=1.5)
head(d)
ggplot(d, aes(x=YearWeek, y=SpecRuns, fill=Instruments)) + geom_bar(stat='identity')
ggplot(d, aes(x=YearWeek, y=SpecRuns, fill=Panels)) + geom_bar(stat='identity')
View(d)
View(f)
head(a)
head(b)
head(d)
head(f)
ggplot(d, aes(x=YearWeek, y=TURN, group=1)) + geom_line(color='black', lwd=1.5) + geom_line(data=f, aes(x=YearWeek, y=TURN, group=2), color='blue', lwd=1.5)
library(RODBC)
library(lubridate)
library(xlsx)
library(ggplot2)
library(grid)
library(gridExtra)
library(scales)
library(gtable)
library(RColorBrewer)
library(devtools)
library(dplyr)
library(tidyr)
require(dateManip)
ggplot(d, aes(x=YearWeek, y=TURN, group=1)) + geom_line(color='black', lwd=1.5) + geom_line(data=f, aes(x=YearWeek, y=TURN, group=2), color='blue', lwd=1.5)
head(d)
View(d)
ggplot(d, aes(x=YearWeek, y=SpecRuns, fill=Instruments)) + geom_bar(stat='identity')
rm(a, b, d, f)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
a <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
b <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
ggplot(a, aes(x=YearWeek, y=TURN, group='Else2', color='Else2')) + geom_line(lwd=1.5) + geom_line(data=b, aes(x=YearWeek, y=TURN, group='Else4', color='Else4'), lwd=1.5) + scale_color_manual(values=c('black','blue'))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
f <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
ggplot(a, aes(x=YearWeek, y=TURN, group='Else2', color='Else2')) + geom_line(lwd=1.5) + geom_line(data=b, aes(x=YearWeek, y=TURN, group='Else4', color='Else4'), lwd=1.5) + geom_line(data=f, aes(x=YearWeek, y=TURN, group='Else4med', color='Else4med'), lwd=1.5) + geom_line(data=d, aes(x=YearWeek, y=TURN, group='Else2_med', color='Else2_med'), lwd=1.5) + scale_color_manual(values=c('black','blue','red','darkgreen'))
head(d)
lm(SpecRuns~Instruments, data=d)
summary(lm(SpecRuns~Instruments, data=d))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
rm(a, b, d, f)
a <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
head(a)
sapply(2:(nrow(a)-1), function(x) (a[(x+1),'SpecRuns'] - a[(x-1),'SpecRuns'])/2)
data.frame(YearWeek = a[s:(nrow(a)-1),'YearWeek'], dR = sapply(2:(nrow(a)-1), function(x) (a[(x+1),'SpecRuns'] - a[(x-1),'SpecRuns'])/2))
data.frame(YearWeek = a[2:(nrow(a)-1),'YearWeek'], dR = sapply(2:(nrow(a)-1), function(x) (a[(x+1),'SpecRuns'] - a[(x-1),'SpecRuns'])/2))
merge(a, data.frame(YearWeek = a[2:(nrow(a)-1),'YearWeek'], dR = sapply(2:(nrow(a)-1), function(x) (a[(x+1),'SpecRuns'] - a[(x-1),'SpecRuns'])/2)), by='YearWeek', all.x=TRUE)
a <- merge(a, data.frame(YearWeek = a[2:(nrow(a)-1),'YearWeek'], dR = sapply(2:(nrow(a)-1), function(x) (a[(x+1),'SpecRuns'] - a[(x-1),'SpecRuns'])/2)), by='YearWeek', all.x=TRUE)
head(a)
ggplot(a, aes(x=YearWeek, y=SpecRuns)) + geom_bar(stat='identity') + geom_line(data=a, aes(x=YearWeek, y=dF, group=1), lwd=1.5)
ggplot(a, aes(x=YearWeek, y=SpecRuns)) + geom_bar(stat='identity') + geom_line(data=a, aes(x=YearWeek, y=dR, group=1), lwd=1.5)
View(a)
ggplot(a, aes(x=YearWeek, y=SpecRuns, fill=Instruments)) + geom_bar(stat='identity') + geom_line(data=a, aes(x=YearWeek, y=dR, group=1), lwd=1.5)
lm(SpecRuns~Instruments, data=a[1:52, ])
lm(SpecRuns~Instruments, data=a[52:104, ])
lm(SpecRuns~Instruments, data=a[104:156, ])
a[104:156, 'YearWeek']
summary(lm(SpecRuns~Instruments, data=a[104:156, ]))
ggplot(a, aes(x=YearWeek, y=SpecRuns, fill=Instruments)) + geom_bar(stat='identity') + geom_line(data=a, aes(x=YearWeek, y=dR, group=1), lwd=1.5) + scale_x_discrete(breaks=a$YearWeek[seq(1, nrow(a), 12)]) + theme(axis.text.x=element_text(angle=90))
head(a)
a[104:156, 'SpecRuns']/21/a[104:156,'Instruments']*summary(lm(SpecRuns~Instruments, data=a[104:156, ]))$r.squared + (1-summary(lm(SpecRuns~Instruments, data=a[104:156, ]))$r.squared)*a[104:156, 'SpecRuns']/21
summary(lm(SpecRuns~Instruments, data=a[156:208, ]))
a[156:208, 'SpecRuns']/21/a[156:208,'Instruments']*summary(lm(SpecRuns~Instruments, data=a[156:208, ]))$r.squared + (1-summary(lm(SpecRuns~Instruments, data=a[156:208, ]))$r.squared)*a[156:208, 'SpecRuns']/21
a[156:208, 'YearWeek']
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
b <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
head(b)
View(b)
ggplot(b, aes(x=YearWeek, y=TURN, group='TURN - no denom')) + geom_line()
sapply(2:(nrow(b)-2), function(x) sum(b[(x-2):(x+2), 'Gap']))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
d
head(d)
ggplot(b, aes(x=YearWeek, y=TURN, group='TURN - no denom')) + geom_line() + geom_line(data=d, aes(x=YearWeek, y=adjTURN, group='TURN - baseline'))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
View(goog.flu.df)
View(d)
quantile(d[150:200, 'TURN'], probs=0.1)
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
ggplot(b, aes(x=YearWeek, y=TURN, group='TURN - no denom', color='TURN - no denom')) + geom_line() + geom_line(data=d, aes(x=YearWeek, y=adjTURN, group='TURN - baseline', color='TURN - baseline')) + scale_color_manual(values=c('black','red'))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
ggplot(b, aes(x=YearWeek, y=TURN, group='TURN - no denom', color='TURN - no denom')) + geom_line() + geom_line(data=d, aes(x=YearWeek, y=adjTURN, group='TURN - baseline', color='TURN - baseline')) + scale_color_manual(values=c('black','red'))
source('~/FilmArrayTrend/Rfunctions/TURN_omega.R', echo=TRUE)
d <- turn(runs.reg.date, 'CustomerSiteId','5','RP', calendar.df, 30)
ggplot(b, aes(x=YearWeek, y=TURN, group='TURN - no denom', color='TURN - no denom')) + geom_line() + geom_line(data=d, aes(x=YearWeek, y=adjTURN, group='TURN - baseline', color='TURN - baseline')) + scale_color_manual(values=c('black','red'))
ggplot(b, aes(x=YearWeek, y=10*TURN, group='TURN - no denom', color='TURN - no denom')) + geom_line() + geom_line(data=d, aes(x=YearWeek, y=adjTURN, group='TURN - baseline', color='TURN - baseline')) + scale_color_manual(values=c('black','red'))
ggplot(b, aes(x=YearWeek, y=20*TURN, group='TURN - no denom', color='TURN - no denom')) + geom_line() + geom_line(data=d, aes(x=YearWeek, y=adjTURN, group='TURN - baseline', color='TURN - baseline')) + scale_color_manual(values=c('black','red'))
